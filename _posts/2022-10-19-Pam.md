# Pam

• Linux 인증 모듈 PAM(Pluggable Authentication Modules) 

- 응용 프로그램에서 사용자 인증을 수행할 수 있게 공통적인 인증 방법을 제공하는 인증 모듈 
- 인증 모듈의 교체 및 추가/삭제가 용이 
- 개발자가 작성한 코드에 의한 인증이 아닌 시스템 관리자가 직접 응용프로그램의 인증 동작을 제어 
  - 응용 프로그램(서비스)에서 PAM을 호출하여 인증 처리 요청
  - 응용 프로그램 개발자가 사용자 인증에 신경 쓰지 않아도 되고, 시스템 관리자가 직접 응용 프로그램 의 인증 동작을 세밀하게 제어 가능 
- 다양한 인증 모듈을 호출하여 사용자 인증 과정을 수행 후 모듈 결과에 맞는 행동을 함 
- 모듈의 종류가 다양하며 인증 절차에 확실한 개념이 필요 
- 라이브러리 형태로 구동(windows 응용 프로그램의 DLL과 같은 라이브러리) 
- 악의적으로 이용할 경우 인증 설정 파일을 이용하여 인증을 수행하지 않고 계정에 접근이 가능

<br>

• PAM 동작 원리 

- 프로그램에서 사용자 인증 필요 시 PAM 라이브러리 함수 호출 
- PAM 호출 시 호출한 응용프로그램의 인증 설정 파일 검사 
  - 설정 파일이 존재하지 않을 경우 기본 설정 파일(other) 사용 
  - 설정 파일은 사용자 인증을 검사하기 위해 필요한 유형을 가지며 이를 기초로 적절한 모듈 호출 
  - 구문에 맞는 인증 모듈을 통해 여러 가지 검사 수행 
- 모듈의 인증 결과에 의해 결과 메시지가 결정되어 응용프로그램에 전달 

<br>

##### PAM 인증 절차 

1) 사용자가 서비스를 이용 받기 위해 접근 
   - Local Service : login, gdm, gdm-password, passwd, reboot, setup, su, su-l, sudo, sudo-i, ... 
   - Remote Service : remote, smtp.postfix, sshd, vsftpd, ... 
2) 프로세스(로컬, 데몬)은 PAM에 인증 요청 
3) PAM은 개별 서비스 인증을 수행하기 위해 요청한 /etc/pam.d 하위에서 요청한 프로세스 이름에 해당하 는 설정 파일 검사 
4) 설정 파일의 구문에 의해 PAM 라이브러리 호출 및 결과 메시지 생성 후 프로세스에 반환 
5) 프로세스는 반환된 결과에 의해 적절한 행동 수행

<br>

PAM 의 영향을 받는 서비스의 목록 : 해당 목록에 없으면 PAM 의 영향을 받지 않는다

![2022-10-19-01pam](../images/2022-10-19-Pam/2022-10-19-01pam.jpg)

<br>

2. 프로세스(로컬, 데몬)은 PAM에 인증 요청 

3. PAM은 개별 서비스 인증을 수행하기 위해 요청한 /etc/pam.d 하위에서 요청한 프로세스 이름에 해당하 는 설정 파일 검사 

```
su 를 사용할때 인증 요청 아래파일을 참조에하여 인증을 진행 
vim /etc/pam.d/su

#%PAM-1.0
auth            sufficient      pam_rootok.so
# Uncomment the following line to implicitly trust users in the "wheel" group.
#auth           sufficient      pam_wheel.so trust use_uid
# Uncomment the following line to require a user to be in the "wheel" group.
#auth           required        pam_wheel.so use_uid
auth            include         system-auth
account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
account         include         system-auth
password        include         system-auth
session         include         system-auth
session         optional        pam_xauth.so

비슷한 다른파일도 확인 : 비슷함 
vim /etc/pam.d/sshd

#%PAM-1.0
auth       required     pam_sepermit.so
auth       include      password-auth
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open env_params
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      password-auth

인증관련모듈 저장 
ls /lib64/security/

pam_access.so        pam_faildelay.so      pam_krb5.so       pam_nologin.so           pam_sepermit.so    pam_unix.so
pam_cap.so           pam_faillock.so       pam_krb5afs.so    pam_oddjob_mkhomedir.so  pam_shells.so      pam_unix_acct.so
pam_chroot.so        pam_filter            pam_lastlog.so    pam_passwdqc.so          pam_smbpass.so     pam_unix_auth.so
pam_ck_connector.so  pam_filter.so         pam_limits.so     pam_permit.so            pam_sss.so         pam_unix_passwd.so
pam_console.so       pam_fprintd.so        pam_listfile.so   pam_postgresok.so        pam_stress.so      pam_unix_session.so
pam_cracklib.so      pam_ftp.so            pam_localuser.so  pam_pwhistory.so         pam_succeed_if.so  pam_userdb.so
pam_debug.so         pam_gnome_keyring.so  pam_loginuid.so   pam_rhosts.so            pam_tally2.so      pam_warn.so
pam_deny.so          pam_group.so          pam_mail.so       pam_rootok.so            pam_time.so        pam_wheel.so
pam_echo.so          pam_issue.so          pam_mkhomedir.so  pam_securetty.so         pam_timestamp.so   pam_winbind.so
pam_env.so           pam_keyinit.so        pam_motd.so       pam_selinux.so           pam_tty_audit.so   pam_xauth.so
pam_exec.so          pam_krb5              pam_namespace.so  pam_selinux_permit.so    pam_umask.so
```

<br>

4. 설정 파일의 구문에 의해 PAM 라이브러리 호출 및 결과 메시지 생성 후 프로세스에 반환 

```
/etc/pam.d/~ 의 파일에 구성된 순서대로 인증을 진행하고 결과를 프로세스에 성공/실패로 반환한다 
```

<br>

5. 프로세스는 반환된 결과에 의해 적절한 행동 수행

```
[ktest@localhost ~]$ su - test01
암호:
su: incorrect password
```

<br>

<br>

<br>

#####  pam_permit.so

해당 모듈 설명

![2022-10-19-02모듈설명](../images/2022-10-19-Pam/2022-10-19-02모듈설명.jpg)

<br>

모듈 적용 방식 

```
/etc/pam.d/su

1 #%PAM-1.0
2 auth            sufficient      pam_permit.so (이부분 입니다.)
3 auth            sufficient      pam_rootok.so
4 # Uncomment the following line to implicitly trust users in the "wheel" group.
5 #auth           sufficient      pam_wheel.so trust use_uid
6 # Uncomment the following line to require a user to be in the "wheel" group.
7 #auth           required        pam_wheel.so use_uid
8 auth            include         system-auth
9 account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
10 account         include         system-auth
11 password        include         system-auth
12 session         include         system-auth
13 session         optional        pam_xauth.so
```

<br>

확인

```
root 제외하고 원래 일반사용자는 su 사용시 root(수퍼유저) 비번 입력 

모듈 적용 전
[ktest@localhost ~]$ su - 
암호:
[root@localhost ~]#

모듈 적용 후
[root@localhost ~]# su - ktest
[ktest@localhost ~]$ su -
[root@localhost ~]#
```

비밀번호 없이 로그인이 되는 모습 입니다.

<br>

<br>

<br>

#####  pam_deny.so 

해당 모듈 설명

![2022-10-19-04모듈설명](../images/2022-10-19-Pam/2022-10-19-04모듈설명.jpg)

<br>

모듈 적용 방식 (requiste)

```
vim /etc/pam.d/su

1 #%PAM-1.0
2 #auth           sufficient      pam_permit.so
3 auth            requisite      pam_deny.so (이부분 입니다.)
4 auth            sufficient      pam_rootok.so
5 # Uncomment the following line to implicitly trust users in the "wheel" group.
6 #auth           sufficient      pam_wheel.so trust use_uid
7 # Uncomment the following line to require a user to be in the "wheel" group.
8 #auth           required        pam_wheel.so use_uid
9 auth            include         system-auth
10 account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
11 account         include         system-auth
12 password        include         system-auth
13 session         include         system-auth
14 session         optional        pam_xauth.so
```

<br>

확인

![2022-10-19-05확인](../images/2022-10-19-Pam/2022-10-19-05확인.jpg)

<br>

모듈 적용 방식 (required)

```
vim /etc/pam.d/su

1 #%PAM-1.0
2 #auth           sufficient      pam_permit.so
3 auth            required      pam_deny.so (이부분 입니다.)
4 auth            sufficient      pam_rootok.so
5 # Uncomment the following line to implicitly trust users in the "wheel" group.
6 #auth           sufficient      pam_wheel.so trust use_uid
7 # Uncomment the following line to require a user to be in the "wheel" group.
8 #auth           required        pam_wheel.so use_uid
9 auth            include         system-auth
10 account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
11 account         include         system-auth
12 password        include         system-auth
13 session         include         system-auth
14 session         optional        pam_xauth.so
```

<br>

확인

![2022-10-19-06확인](../images/2022-10-19-Pam/2022-10-19-06확인.jpg)

정확한 비밀번호를 입력해도 사용자 변경 X 

<br>

##### pam_rootok.so

해당 모듈 설명

![2022-10-19-07모듈설명](../images/2022-10-19-Pam/2022-10-19-07모듈설명.jpg)

<br>

모듈 적용 방식 (sufficient)

```
/etc/pam.d/su

#%PAM-1.0
auth            sufficient      pam_rootok.so (이부분 입니다.)
# Uncomment the following line to implicitly trust users in the "wheel" group.
#auth           sufficient      pam_wheel.so trust use_uid
# Uncomment the following line to require a user to be in the "wheel" group.
#auth           required        pam_wheel.so use_uid
auth            include         system-auth
account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
account         include         system-auth
password        include         system-auth
session         include         system-auth
session         optional        pam_xauth.so
```

![2022-10-19-08모듈설명](../images/2022-10-19-Pam/2022-10-19-08모듈설명.jpg)

<br>

모듈 적용 방식 (required)

```
/etc/pam.d/su

#%PAM-1.0
auth            required        pam_rootok.so(이부분 입니다.)
# Uncomment the following line to implicitly trust users in the "wheel" group.
#auth           sufficient      pam_wheel.so trust use_uid
# Uncomment the following line to require a user to be in the "wheel" group.
#auth           required        pam_wheel.so use_uid
auth            include         system-auth
account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
account         include         system-auth
password        include         system-auth
session         include         system-auth
session         optional        pam_xauth.so
```

![2022-10-19-09모듈설명](../images/2022-10-19-Pam/2022-10-19-09모듈설명.jpg)

<br>

확인

```
[root@localhost 바탕화면]# su - ktest
암호:
[ktest@localhost ~]$

[ktest@localhost ~]$ su -
암호:
su: incorrect password
```

<br>

<br>

<br>

##### pam_wheel.so

해당 모듈 설명

![2022-10-19-10모듈설명](../images/2022-10-19-Pam/2022-10-19-10모듈설명.jpg)

<br>

모듈 적용 방식 (sufficient)

```
/etc/pam.d/su

#%PAM-1.0
auth            sufficient      pam_rootok.so
# Uncomment the following line to implicitly trust users in the "wheel" group.
auth            sufficient      pam_wheel.so trust use_uid(이부분 입니다.)
# Uncomment the following line to require a user to be in the "wheel" group.
#auth           required        pam_wheel.so use_uid
auth            include         system-auth
account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
account         include         system-auth
password        include         system-auth
session         include         system-auth
session         optional        pam_xauth.so
```

<br>

확인

![2022-10-19-11그룹](../images/2022-10-19-Pam/2022-10-19-11그룹.jpg)

```
사용자    소속그룹
ktest     ktest
test02    wheel

test02 사용자를 새로 생성하면서 소속그룹을 wheel 그룹으로 지정 
[root@localhost pam.d]# useradd test02 -g testgroup
useradd: 'testgroup' 그룹이 없습니다
[root@localhost pam.d]# grep wheel /etc/group
wheel:x:10:

[root@localhost pam.d]# useradd test02 -g wheel

[root@localhost pam.d]# grep test02 /etc/passwd
test02:x:502:10::/home/test02:/bin/bash

[root@localhost pam.d]# tail -1 /etc/passwd
test02:x:502:10::/home/test02:/bin/bash

[root@localhost pam.d]# grep ktest /etc/passwd
ktest:x:500:500::/home/ktest:/bin/bash

[root@localhost pam.d]# grep 500 /etc/group
ktest:x:500:


pam_rootok 의 영향 
[root@localhost pam.d]# su -
[root@localhost ~]# su - test01
[test01@localhost ~]$

pam_wheel.so 에 모듈실패(sufficient) , 비밀번호 맞으면 su 서비스 성공 
[ktest@localhost ~]$ su -
암호:
[root@localhost ~]#

pam_wheel.so 에 모듈성공 (sufficient)  비밀번호 입력없이 su 서비스 성공 
[test02@localhost ~]$ su -
[root@localhost ~]#
```

<br>

모듈 적용 방식 (required)

```
/etc/pam.d/su

#%PAM-1.0
auth            sufficient      pam_rootok.so
# Uncomment the following line to implicitly trust users in the "wheel" group.
# auth            sufficient      pam_wheel.so trust use_uid
# Uncomment the following line to require a user to be in the "wheel" group.
auth           required        pam_wheel.so use_uid (이부분 입니다.)
auth            include         system-auth
account         sufficient      pam_succeed_if.so uid = 0 use_uid quiet
account         include         system-auth
password        include         system-auth
session         include         system-auth
session         optional        pam_xauth.so
```

<br>

확인

```
pam_rootok 의 영향 
[root@localhost ~]# su - ktest
[ktest@localhost ~]$

pam_wheel.so 에 모듈실패(required) , 비밀번호 맞으면 su 서비스 실패
[ktest@localhost ~]$ su -
암호:
su: incorrect password

test02
[test02@localhost ~]$ su -
암호:
```

<br>

